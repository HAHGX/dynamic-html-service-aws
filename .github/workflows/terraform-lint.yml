name: Terraform Lint

on:
    pull_request:
        paths:
            - '**/*.tf'
            - '**/*.tfvars'

jobs:
    terraform-lint:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write
        steps:
              - name: Checkout code
                uses: actions/checkout@v4
        
              - name: Set up Terraform
                uses: hashicorp/setup-terraform@v3
        
              - name: Terraform Format Check
                id: fmt
                run: terraform fmt -check -recursive
                continue-on-error: true
        
              - name: Terraform Validate
                id: validate
                run: terraform validate
                continue-on-error: true
        
              - name: Generate Lint Report
                id: report
                run: |
                  {
                    echo "## Terraform Lint Report"
                    echo ""
                    echo "**Format Check:**"
                    terraform fmt -check -recursive || echo "Formatting issues found."
                    echo ""
                    echo "**Validate:**"
                    terraform validate || echo "Validation issues found."
                  } > lint-report.md
        
              - name: Publish Lint Report to PR
                uses: marocchino/sticky-pull-request-comment@v2
                with:
                  path: lint-report.md
                  token: ${{ secrets.GITHUB_TOKEN }}